<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>对象分配与类加载机制 | Derek&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blogs/blogs/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <meta name="description" content="">
    
    <link rel="preload" href="/blogs/assets/css/0.styles.4772688d.css" as="style"><link rel="preload" href="/blogs/assets/js/app.7d827f20.js" as="script"><link rel="preload" href="/blogs/assets/js/2.2efa6d08.js" as="script"><link rel="preload" href="/blogs/assets/js/31.44b2519f.js" as="script"><link rel="prefetch" href="/blogs/assets/js/10.0e204dab.js"><link rel="prefetch" href="/blogs/assets/js/11.acf96497.js"><link rel="prefetch" href="/blogs/assets/js/12.0643a22b.js"><link rel="prefetch" href="/blogs/assets/js/13.ca8dd081.js"><link rel="prefetch" href="/blogs/assets/js/14.8bd7b5bd.js"><link rel="prefetch" href="/blogs/assets/js/15.dddb67ac.js"><link rel="prefetch" href="/blogs/assets/js/16.5242688e.js"><link rel="prefetch" href="/blogs/assets/js/17.f03cee5b.js"><link rel="prefetch" href="/blogs/assets/js/18.62a2e5df.js"><link rel="prefetch" href="/blogs/assets/js/19.4ed6e5ac.js"><link rel="prefetch" href="/blogs/assets/js/20.fe87e68d.js"><link rel="prefetch" href="/blogs/assets/js/21.1ca37d7d.js"><link rel="prefetch" href="/blogs/assets/js/22.45f9a0ab.js"><link rel="prefetch" href="/blogs/assets/js/23.5b67a25f.js"><link rel="prefetch" href="/blogs/assets/js/24.864743b6.js"><link rel="prefetch" href="/blogs/assets/js/25.fbb19ce7.js"><link rel="prefetch" href="/blogs/assets/js/26.ae5b791b.js"><link rel="prefetch" href="/blogs/assets/js/27.e490a9f9.js"><link rel="prefetch" href="/blogs/assets/js/28.be291e07.js"><link rel="prefetch" href="/blogs/assets/js/29.a8e70b32.js"><link rel="prefetch" href="/blogs/assets/js/3.42c52160.js"><link rel="prefetch" href="/blogs/assets/js/30.54098e09.js"><link rel="prefetch" href="/blogs/assets/js/32.5700c00a.js"><link rel="prefetch" href="/blogs/assets/js/33.d2d52e2a.js"><link rel="prefetch" href="/blogs/assets/js/34.925f7e33.js"><link rel="prefetch" href="/blogs/assets/js/35.ea00a34f.js"><link rel="prefetch" href="/blogs/assets/js/36.8892caa6.js"><link rel="prefetch" href="/blogs/assets/js/37.ef15a63c.js"><link rel="prefetch" href="/blogs/assets/js/38.6d00dfc0.js"><link rel="prefetch" href="/blogs/assets/js/4.bd087c12.js"><link rel="prefetch" href="/blogs/assets/js/5.4e180a65.js"><link rel="prefetch" href="/blogs/assets/js/6.1ef65951.js"><link rel="prefetch" href="/blogs/assets/js/7.01575413.js"><link rel="prefetch" href="/blogs/assets/js/8.732510c7.js"><link rel="prefetch" href="/blogs/assets/js/9.8a6dd667.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.4772688d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><img src="/blogs/blogs/favicon.ico" alt="Derek's blog" class="logo"> <span class="site-name can-hide">Derek's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/bcld/blogs/tree/master" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/essayist/" class="nav-link">
  随谈
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/foundation/" class="nav-link">
  朝花夕拾
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/private/" class="nav-link">
  私境
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/server/" class="nav-link router-link-active">
  后端
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/blogs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/bcld/blogs/tree/master" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/essayist/" class="nav-link">
  随谈
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/foundation/" class="nav-link">
  朝花夕拾
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/private/" class="nav-link">
  私境
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/server/" class="nav-link router-link-active">
  后端
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/blogs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>后端</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/docs/server/CAP理论及应用架构.html" class="sidebar-link">CAP理论及应用架构</a></li><li><a href="/blogs/docs/server/java的锁.html" class="sidebar-link">JAVA的锁</a></li><li><a href="/blogs/docs/server/jvm内存结构概述.html" class="sidebar-link">JVM内存结构剖析</a></li><li><a href="/blogs/docs/server/jvm对象分配机制.html" class="active sidebar-link">对象分配与类加载机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_1-1-对象加载流程" class="sidebar-link">1.1 对象加载流程</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_1-2-类加载流程" class="sidebar-link">1.2 类加载流程</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_1-3-类加载器" class="sidebar-link">1.3 类加载器</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_2-1-对象头" class="sidebar-link">2.1 对象头</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_2-2-实例数据" class="sidebar-link">2.2 实例数据</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_2-3-对齐填充" class="sidebar-link">2.3 对齐填充</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_2-4-指针压缩" class="sidebar-link">2.4 指针压缩</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm对象分配机制.html#_2-5-对象大小计算" class="sidebar-link">2.5 对象大小计算</a></li></ul></li><li><a href="/blogs/docs/server/kafka初认识.html" class="sidebar-link">Kafka初认识</a></li><li><a href="/blogs/docs/server/mysql答疑.html" class="sidebar-link">Mysql答疑</a></li><li><a href="/blogs/docs/server/raft一致性协议.html" class="sidebar-link">RAFT</a></li><li><a href="/blogs/docs/server/Redis浅谈.html" class="sidebar-link">浅谈Redis</a></li><li><a href="/blogs/docs/server/RocketMq初认识.html" class="sidebar-link">RocketMq初认识</a></li><li><a href="/blogs/docs/server/TCP相关.html" class="sidebar-link">TCP相关</a></li><li><a href="/blogs/docs/server/分布式锁.html" class="sidebar-link">分布式锁技术</a></li><li><a href="/blogs/docs/server/消息中间件.html" class="sidebar-link">消息中间件</a></li><li><a href="/blogs/docs/server/类加载机制.html" class="sidebar-link">类加载机制</a></li><li><a href="/blogs/docs/server/网络IO模型.html" class="sidebar-link">网络IO模型</a></li><li><a href="/blogs/docs/server/零拷贝技术.html" class="sidebar-link">零拷贝技术</a></li><li><a href="/blogs/docs/server/面试常见问题.html" class="sidebar-link">面试常见问题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="对象分配与类加载机制"><a href="#对象分配与类加载机制" class="header-anchor">#</a> 对象分配与类加载机制</h1> <p><img src="E:%5CMyBlog%5CpriBlog%5Cblogs.vuepress%5Cpublic_images%5Cjvm%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6%5Cimage-20220527180101601.png" alt="image-20220527180101601"></p> <h2 id="_1-1-对象加载流程"><a href="#_1-1-对象加载流程" class="header-anchor">#</a> 1.1 对象加载流程</h2> <h3 id="_1-1-1-使用对象"><a href="#_1-1-1-使用对象" class="header-anchor">#</a> 1.1.1 使用对象</h3> <p>这里指的是代码里new了一个对象</p> <h3 id="_1-1-2-类加载检查"><a href="#_1-1-2-类加载检查" class="header-anchor">#</a> 1.1.2 类加载检查</h3> <p>对象在首次new的时候，或者首次使用的时候（静态方法），都会触发类加载检查。</p> <h3 id="_1-1-3-分配内存"><a href="#_1-1-3-分配内存" class="header-anchor">#</a> 1.1.3 分配内存</h3> <p>给对象分配一块连续的内存，如果内存规整，会采用指针碰撞的方式分配。如果内存不规整，会采用空闲列表的方式分配。</p> <p><strong>指针碰撞</strong></p> <p>所有被使用过的内存都被放在一边，空闲的内存被放在另一边，中间放着一个指针作为分界点的指示器，那所分配内存就仅仅是把那个指针向空闲空间方向挪动一段与对象大小相等的距离，这种分配方式称为“指针碰撞”。</p> <p><strong>空闲列表</strong></p> <p>虚拟机维护一个列表，记录上哪些内存块是可用的，在分配的时候从列表中找到一块足够大的空间划分给对象实例，并更新列表上的记录，这种分配方式称为“空闲列表”。</p> <h5 id="_1-1-3-1-内存分配时的并发冲突"><a href="#_1-1-3-1-内存分配时的并发冲突" class="header-anchor">#</a> 1.1.3.1 内存分配时的并发冲突</h5> <p>除如何划分可用空间之外，还有另外一个需要考虑的问题：对象创建在虚拟机中是非常频繁的行为，即使仅仅修改一个指针所指向的位置，在并发情况下也并不是线程安全的，可能出现正在给对象A分配内存，指针还没来得及修改，对象B又同时使用了原来的指针来分配内存的情况。解决这个问题有两种可选方案。</p> <p><strong>CAS</strong></p> <p>采用CAS配合失败重试的方式保证更新操作的原子性</p> <p>TLAB</p> <p>种是把内存分配的动作按照线程划分在不同的空间之中进行，即每个线程在Java堆中预先分配一小块内存，称为本地线程分配缓冲（Thread Local AllocationBuffer，TLAB），哪个线程要分配内存，就在哪个线程的本地缓冲区中分配，只有本地缓冲区用完了，分配新的缓存区时才需要同步锁定。虚拟机是否使用TLAB，可以通过-XX：+/-UseTLAB参数来设定</p> <h5 id="_1-1-4-初始化内存"><a href="#_1-1-4-初始化内存" class="header-anchor">#</a> 1.1.4 初始化内存</h5> <p>内存分配完成之后，虚拟机必须将分配到的内存空间（但不包括对象头）都初始化为零值，如果使用了TLAB的话，这一项工作也可以提前至TLAB分配时顺便进行。这步操作保证了对象的实例字段在Java代码中可以不赋初始值就直接使用，使程序能访问到这些字段的数据类型所对应的零值</p> <h5 id="_1-1-5-设置对象头"><a href="#_1-1-5-设置对象头" class="header-anchor">#</a> 1.1.5 设置对象头</h5> <p>接下来，Java虚拟机还设置好对象的对象头。对象头详细结构会在下文详细说明</p> <h5 id="_1-1-6-执行-方法"><a href="#_1-1-6-执行-方法" class="header-anchor">#</a> 1.1.6 执行<init>()方法</init></h5> <p>Java编译器会在遇到new关键字的地方同时生成这两条字节码指令，1-new指令，2-<init>()方法。</init></p> <p>new指令表示对象初始化</p> <p><init>()方法表示执行对象初始化方法以及相应的构造方法</init></p> <p>这样一个真正可用的对象才算完全被构造出来</p> <h2 id="_1-2-类加载流程"><a href="#_1-2-类加载流程" class="header-anchor">#</a> 1.2 类加载流程</h2> <p><img src="E:%5CMyBlog%5CpriBlog%5Cblogs.vuepress%5Cpublic_images%5Cjvm%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6%5Cimage-20220527180114762.png" alt="image-20220527180114762"></p> <h3 id="_1-2-1-加载"><a href="#_1-2-1-加载" class="header-anchor">#</a> 1.2.1 加载</h3> <p>通过一个类的全限定名来获取定义此类的二进制字节流，将该字节数据加载进内存中</p> <p>由于class文件是二进制文件，可以以如下方式加载：</p> <p>从jar，war，class文件中读取类的字节流
从网络数据中读取类的字节流，Web Applet
运行时动态生成，例如cglib，Jdk动态代理
由JSP文件动态生成
由数据库读取
......</p> <h3 id="_1-2-2-验证"><a href="#_1-2-2-验证" class="header-anchor">#</a> 1.2.2 验证</h3> <p>这个阶段主要是校验字节码是否符合规范</p> <h3 id="_1-2-3-准备"><a href="#_1-2-3-准备" class="header-anchor">#</a> 1.2.3 准备</h3> <p>这个阶段主要是分配类里面定义的静态变量所用的内存，并进行内存初始化</p> <h3 id="_1-2-4-解析"><a href="#_1-2-4-解析" class="header-anchor">#</a> 1.2.4 解析</h3> <p>这个阶段主要是进行静态连接过程。</p> <p>静态连接指的是在类加载过程中，将符号引用转化为直接引用。</p> <h3 id="_1-2-5-初始化"><a href="#_1-2-5-初始化" class="header-anchor">#</a> 1.2.5 初始化</h3> <p>初始化阶段就是执行类构造器<clinit>()方法的过程</clinit></p> <p><clinit>()方法主要完成如下动作：</clinit></p> <p>执行父类的<clinit>()方法
初始化static变量
执行static代码块</clinit></p> <h2 id="_1-3-类加载器"><a href="#_1-3-类加载器" class="header-anchor">#</a> 1.3 类加载器</h2> <p>类加载器用于实现Java的类加载过程。对于任意一个类，在同一类加载器下面保证唯一性。</p> <p>换句话说，同一个类可以被不同类加载器加载，并且在不同类加载器中各自被加载一次。</p> <p>比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义，否则，即使这两个类来源于同一个Class文件，被同一个Java虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等</p> <p>这里所指的“相等”，包括代表类的Class对象的equals()方法、isAssignableFrom()方法、isInstance()方法的返回结果，也包括了使用instanceof关键字做对象所属关系判定等各种情况。如果没有注意到类加载器的影响，在某些情况下可能会产生具有迷惑性的结果</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>midea<span class="token punctuation">.</span>jvm</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 类加载器与instanceof关键字演示
 *
 * 
 */</span>
 <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoaderTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassLoader</span> myLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> fileName <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">;</span>
                    <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>is <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>is<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    is<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> myLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;com.midea.jvm.ClassLoaderTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">ClassLoaderTest</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_1-3-1-双亲委派模型"><a href="#_1-3-1-双亲委派模型" class="header-anchor">#</a> 1.3.1 双亲委派模型</h3> <p>双亲委派模型要求除了顶层的启动类加载器外，其余的类加载器都应有自己的父类加载器。不过这里类加载器之间的父子关系一般不是以继承的关系来实现的，而是通常使用组合关系来复用父加载器的代码</p> <p><img src="E:%5CMyBlog%5CpriBlog%5Cblogs.vuepress%5Cpublic_images%5Cjvm%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6%5Cimage-20220527180128284.png" alt="image-20220527180128284"></p> <p>如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到最顶层的启动类加载器中，只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去完成加载</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>loadClass代码：

<span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// First, check if the class has already been loaded</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//这里先委托父加载器加载</span>
                    <span class="token comment">//如果没有父加载器，表示父加载器为BootstrapClassLoader</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ClassNotFoundException thrown if class not found</span>
                    <span class="token comment">// from the non-null parent class loader</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//如果父加载器不能加载，再尝试自己加载</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// If still not found, then invoke findClass in order</span>
                    <span class="token comment">// to find the class.</span>
                    <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
                    <span class="token comment">// this is the defining class loader; record the stats</span>
                    <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>启动类加载器(Bootstrap Class Loader)</p> <p>启动类加载器是由C++实现的，负责加载$JAVA_HOME/lib目录中的类库，当然名字不符合的类库即使放在lib目录中也不会被加载</p> <p>扩展类加载器(Extension Class Loader)</p> <p>扩展类加载器是以Java代码实现的，负责加载$JAVA_HOME/lib/ext目录中的类库</p> <p>应用类加载器(Application Class Loader)</p> <p>应用类加载器负责加载ClassPath范围内所有的类，也是开发者在使用Java时的默认的类加载器</p> <p>自定义类加载器(Application Class Loader)</p> <p>如果系统提供的类加载器无法满足需求，可以自行实现自定义类加载器</p> <p>实现自定义加载器可以继承ClassLoader并关注如下方法：</p> <p>findClass：该方法需要子类重写，实现传入类名，返回类的Class对象</p> <p>loadClass：如果子类想打破双亲委派机制，可以实现该方法</p> <p>defineClass：该方法传入JavaClass的字节流，加载并返回Class对象</p> <p>双亲委派模型的目的：</p> <p>防止系统关键类被用户定义，例如String,Integer等
防止类的重复加载</p> <h3 id="_1-3-2-全盘委托机制"><a href="#_1-3-2-全盘委托机制" class="header-anchor">#</a> 1.3.2 全盘委托机制</h3> <p>当一个classloader加载一个Class的时候，这个Class所依赖的和引用的其它Class通常也由这个classloader负责载入。</p> <p>通常全盘委托机制也同时遵循双亲委派模型。</p> <h3 id="_1-3-3-自定义类加载器实现"><a href="#_1-3-3-自定义类加载器实现" class="header-anchor">#</a> 1.3.3 自定义类加载器实现</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token class-name">MainClz</span><span class="token punctuation">.</span>java

<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>midea<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>loader</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainClz</span> <span class="token punctuation">{</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span>
    <span class="token class-name">DiskClassLoader</span> diskClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiskClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> runnerClz <span class="token operator">=</span> diskClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;com.midea.jvm.loader.TestRunner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">)</span> runnerClz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token class-name">DiskClassLoader</span><span class="token punctuation">.</span>java

<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>midea<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>loader</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiskClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;com.midea.jvm.loader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> simpleName <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>simpleName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;E://&quot;</span> <span class="token operator">+</span> simpleName <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>fis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>这里实现了DiskClassLoader，会自动从D盘查找对应class文件，然后加载。</p> <h3 id="_1-3-4-打破双亲委派模型"><a href="#_1-3-4-打破双亲委派模型" class="header-anchor">#</a> 1.3.4 打破双亲委派模型</h3> <p>线程上下文类加载器</p> <p>java很多系统类提供了spi扩展，例如JDBC</p> <p>由于全盘委托机制，系统类以及期依赖都默认采用bootsrtap类加载器加载所有实现类。</p> <p>这样的话，读取spi实现类的时候，由于spi实现类在用户classpath内，导致无法被加载到</p> <p>所以需要在系统类里面有个机制获取AppClassloader</p> <p>这里就引入了ThreadContextClassloader，子线程创建的时候，会将父线程classloader保存进去，最终会将Appclassloader保存在Thread上下文中</p> <p>所以系统类通过获取当前thread的线程上下文加载器，可以拿到AppClassloader</p> <p>Tomcat打破双亲委派机制</p> <p>Tomcat为何要打破双亲委派机制：</p> <p>应用隔离：部署在同一个Tomcat中的不同应用A和B，假设A用了Spring4。B用了Spring5，那么如果采用双亲委派模型，会导致两个应用无法同时启动</p> <p>热部署：对于一些生产系统来说，关机重启一次可能就要被列为生产事故，这种情况下就需要采用热部署</p> <p>Tomcat官方文档给出的ClassLoader模型：</p> <div class="language- extra-class"><pre><code>  Bootstrap
      |
   System
      |
   Common
   /     \
</code></pre></div><p>Webapp1   Webapp2 ...
2.对象内存模型
对象内存布局分为对象头、实例数据、对齐填充。</p> <h2 id="_2-1-对象头"><a href="#_2-1-对象头" class="header-anchor">#</a> 2.1 对象头</h2> <p>markword(32位JVM)</p> <p>空间占用：4字节</p> <p>|-------------------------------------------------------|--------------------|</p> <table><thead><tr><th>Mark Word (32 bits)</th> <th>State</th></tr></thead> <tbody><tr><td>identity_hashcode:25</td> <td>age:4</td></tr> <tr><td>-------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td>thread:23</td> <td>epoch:2</td></tr> <tr><td>-------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td>ptr_to_lock_record:30</td> <td>lock:2</td></tr> <tr><td>-------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td>ptr_to_heavyweight_monitor:30</td> <td>lock:2</td></tr> <tr><td>-------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td></td> <td>lock:2</td></tr> <tr><td>-------------------------------------------------------</td> <td>--------------------</td></tr></tbody></table> <p>markword(64位JVM)</p> <p>空间占用：8字节</p> <p>|------------------------------------------------------------------------------|--------------------|</p> <table><thead><tr><th>Mark Word (64 bits)</th> <th>State</th></tr></thead> <tbody><tr><td>unused:25</td> <td>identity_hashcode:31</td></tr> <tr><td>------------------------------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td>thread:54</td> <td>epoch:2</td></tr> <tr><td>------------------------------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td>ptr_to_lock_record:62</td> <td>lock:2</td></tr> <tr><td>------------------------------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td>ptr_to_heavyweight_monitor:62</td> <td>lock:2</td></tr> <tr><td>------------------------------------------------------------------------------</td> <td>--------------------</td></tr> <tr><td></td> <td>lock:2</td></tr> <tr><td>------------------------------------------------------------------------------</td> <td>--------------------</td></tr></tbody></table> <p>本章节只讨论Normal状态下的对象头，其他状态将在后续并发编程章节讲述。</p> <p>Mark Word通常状态下，有如下字段：</p> <p>hashcode：用来保存对象的hashcode</p> <p>age：用来保存对象的分代年龄（这里使用4个字节，所以最大可表示值为15）</p> <p>是否偏向锁：略</p> <p>锁标记：略</p> <p>类型指针</p> <p>空间占用：32位系统，64位系统8字节，开启指针压缩4字节</p> <p>用于指针类元数据的指针，注意不是Class指针</p> <p>Java虚拟机通过这个指针来确定该对象是哪个类的实例</p> <p>数组长度</p> <p>空间占用：4字节</p> <p>如果该对象是数据类型，这个字段会存在，并用于保存数组长度</p> <h2 id="_2-2-实例数据"><a href="#_2-2-实例数据" class="header-anchor">#</a> 2.2 实例数据</h2> <p>就是对象中的属性字段，实例数据区域采用4字节对齐。</p> <h2 id="_2-3-对齐填充"><a href="#_2-3-对齐填充" class="header-anchor">#</a> 2.3 对齐填充</h2> <p>对齐填充，没有特别的含义，它仅仅起着占位符的作用。由于HotSpot虚拟机的自动内存管理系统要求对象起始地址必须是8字节的整数倍，换句话说就是任何对象的大小都必须是8字节的整数倍</p> <h2 id="_2-4-指针压缩"><a href="#_2-4-指针压缩" class="header-anchor">#</a> 2.4 指针压缩</h2> <p>由于Java对象都以8字节对齐，所以指针寻址范围相对会增加8倍（1byte→8byte）</p> <p>32位系统的指针大小为4字节，寻址范围是4GB，所以增加8倍后寻址范围为32GB</p> <p>所以在32GB的堆内存范围内，可以开启指针压缩。开启后指针大小为4byte</p> <p>启用指针压缩:-XX:+UseCompressedOops(默认启用)</p> <p>禁止指针压缩:-XX:-UseCompressedOops</p> <h2 id="_2-5-对象大小计算"><a href="#_2-5-对象大小计算" class="header-anchor">#</a> 2.5 对象大小计算</h2> <p>根据上述内容，读者应该能独立计算对象内存大小了，例如new Object()对象大小：</p> <p>假设64位系统，开启指针压缩</p> <p>对象头：markword(8byte)，类型指针4(4byte)</p> <p>实例区域：0byte</p> <p>对齐填充：4byte</p> <p>对象大小16byte</p> <p>jol-core</p> <p>jol-core是查看对象内存详细组成情况的工具包</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>&lt;dependency<span class="token punctuation">&gt;</span>
  &lt;groupId<span class="token punctuation">&gt;</span>org.openjdk.jol&lt;/groupId<span class="token punctuation">&gt;</span>
  &lt;artifactId<span class="token punctuation">&gt;</span>jol<span class="token punctuation">-</span>core&lt;/artifactId<span class="token punctuation">&gt;</span>
  &lt;version<span class="token punctuation">&gt;</span>0.16&lt;/version<span class="token punctuation">&gt;</span>
&lt;/dependency<span class="token punctuation">&gt;</span>
package com.midea.jvm.jol;

import org.openjdk.jol.info.ClassLayout;

/<span class="token important">**</span>
 * @author chenwx57
 * @date 2021/5/31
 <span class="token important">*/</span>
    public class JolTest <span class="token punctuation">{</span>

    public static void main(String<span class="token punctuation">[</span><span class="token punctuation">]</span> args) <span class="token punctuation">{</span>
        String s = ClassLayout.parseInstance(new Object()).toPrintable();
        System.out.println(s);
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>执行后输出：</p> <p>java.lang.Object object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)
8   4        (object header: class)    0xf80001e5
12   4        (object alignment gap)<br>
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
Instance size：表示对象内存占用</p> <p>Space losses：表示对象空白对齐导致损失的空间大小</p> <p>3.对象内存分配
3.1 对象优先在Eden分配
大多数情况下，对象在新生代Eden区中分配。当Eden区没有足够空间进行分配时，虚拟机将发起一次Minor GC</p> <p>3.2 大对象直接进入老年代
大对象就是指需要大量连续内存空间的Java对象，最典型的大对象便是那种很长的字符串，或者元素数量很庞大的数组</p> <p>大对象对虚拟机的内存分配来说就是一个不折不扣的坏消息，比遇到一个大对象更加坏的消息就是遇到一群“朝生夕灭”的“短命大对象”，我们写程序的时候应注意避免。在Java虚拟机中要避免大对象的原因是，在分配空间时，它容易导致内存明明还有不少空间时就提前触发垃圾收集，以获取足够的连续空间才能安置好它们，而当复制对象时，大对象就意味着高额的内存复制开销</p> <p>HotSpot虚拟机提供了-XX：PretenureSizeThreshold参数，指定大于该设置值的对象直接在老年代分配，这样做的目的就是避免在Eden区及两个Survivor区之间来回复制，产生大量的内存复制操作</p> <p>3.3 长期存活的对象将进入老年代
对象通常在Eden区里诞生，如果经过第一次Minor GC后仍然存活，并且能被Survivor容纳的话，该对象会被移动到Survivor空间中，并且将其对象年龄设为1岁。对象在Survivor区中每熬过一次Minor GC，年龄就增加1岁，当它的年龄增加到一定程度（默认为15），就会被晋升到老年代中。对象晋升老年代的年龄阈值，可以通过参数-XX：MaxTenuringThreshold设置</p> <p>3.4 动态对象年龄判定
为了能更好地适应不同程序的内存状况，HotSpot虚拟机并不是永远要求对象的年龄必须达到XX：MaxTenuringThreshold才能晋升老年代</p> <p>如果在Survivor空间中，年龄1+2+3+x的对象大小的总和大于Survivor空间的一半，那么年龄大于等于x对象会提前晋升到老年代</p> <p>3.5 空间分配担保
在发生Minor GC之前，虚拟机必须先检查老年代最大可用的连续空间是否大于新生代所有对象总空间，如果这个条件成立，那这一次Minor GC可以确保是安全的。如果不成立，那么这次Minor GC是不安全的，会先触发FullGC</p> <p>XX：HandlePromotionFailure参数的设置值是否允许担保失败</p> <p>如果允许，那会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果小于那这时会先触发FullGC</p> <p>3.6 栈上分配
java虚拟机提供的一项优化技术，它的基本思想是，对于那些方法局部私有对象可以将它们打散分配在栈上，而不是分配在堆上</p> <p>分配在栈上可以结束后自行销毁，不需要垃圾回收器介入，从而提高系统的性能</p> <p>栈上分配依赖于逃逸分析和标量替换，具体后面章节会做详细介绍</p> <p>开启逃逸分析-XX：+DoEscapeAnalysis(jdk8 server模式默认开启)</p> <p>开启标量替换-XX：+EliminateAllocations(jdk8 server模式默认开启)</p> <p>4.对象内存回收
4.1 finalize()方法
如果对象重写了finalize()方法，那么当垃圾对象被GC时，JVM先会调用finalize()方法，并且在这次GC清理中“放过”这个垃圾对象。如果下次GC这个对象仍然是垃圾对象，则会被回收掉。</p> <p>所以对象可以通过重写finalize()方法进行“自救”，自救的方式是重新和别的对象建立引用关系。</p> <p>一般开发中，禁止使用finalize()方法，因为运行代价高昂，不确定性大，无法保证各个对象的调用顺序，如今已被官方明确声明为不推荐使用的语法。</p> <p>4.2 引用
在JDK 1.2版之后，Java对引用的概念进行了扩充，将引用分为强引用（Strongly Re-ference）、软引用（Soft Reference）、弱引用（Weak Reference）和虚引用（Phantom Reference）4种，这4种引用强度依次逐渐减弱</p> <p>4.2.1 强引用
强引用是在程序代码之中普遍存在的引用赋值，即类似“Objectobj=new Object()”这种引用关系。无论任何情况下，只要强引用关系还存在，垃圾收集器就永远不会回收掉被引用的对象</p> <p>4.2.2 软引用
当对象被软引用时，且不存在其他的强引用，当系统内存不够用时，这个软引用才会被清理</p> <p>软引用因为内存释放的特性，一般用于缓存框架。</p> <p>4.2.3 弱引用
当对象被弱引用时，且不存在其他的强引用，当系统发生GC时，这个弱引用会被清理</p> <p>弱引用基于用完即弃的特性，广泛用于ThreadLocal中。</p> <p>4.2.4 虚引用
当对象被虚引用时，且不存在其他的强引用，这个对象因为GC而被回收时，这个虚引用会被清理</p> <p>虚引用可以结合引用队列(ReferenceQueue)，用于监听对象的回收情况。</p> <p>4.3 类(Class)的回收
类在满足下列条件后回收</p> <p>这个类的所有实例已经回收
这个类的加载器已经回收
这个类的Class实例（包括Method/Field等反射实例）没有引用
5.本章JVM参数说明
这里说明一下，默认开启指的是JDK8含以上，启动模式为server模式：</p> <p>开启TLAB	-XX:+UseTLAB	默认开启
启用指针压缩	-XX:+UseCompressedOops	默认开启
大对象阈值	-XX:PretenureSizeThreshold	默认值是0
分代最大年龄	-XX:MaxTenuringThreshold	CMS默认6，其他默认15
动态年龄判断阈值	-XX:TargetSurvivorRatio	默认50
开启担保失败	-XX:HandlePromotionFailure	JDK7以上强制启用，无需配置
开启逃逸分析	-XX:+DoEscapeAnalysis	默认开启
开启标量替换	-XX:+EliminateAllocations	默认开启</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/27/2022, 6:03:09 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blogs/docs/server/jvm内存结构概述.html" class="prev">
        JVM内存结构剖析
      </a></span> <span class="next"><a href="/blogs/docs/server/kafka初认识.html">
        Kafka初认识
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/blogs/assets/js/app.7d827f20.js" defer></script><script src="/blogs/assets/js/2.2efa6d08.js" defer></script><script src="/blogs/assets/js/31.44b2519f.js" defer></script>
  </body>
</html>
