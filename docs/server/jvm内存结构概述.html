<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM内存结构剖析 | Derek&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blogs/blogs/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <meta name="description" content="">
    
    <link rel="preload" href="/blogs/assets/css/0.styles.4772688d.css" as="style"><link rel="preload" href="/blogs/assets/js/app.7d827f20.js" as="script"><link rel="preload" href="/blogs/assets/js/2.2efa6d08.js" as="script"><link rel="preload" href="/blogs/assets/js/4.bd087c12.js" as="script"><link rel="prefetch" href="/blogs/assets/js/10.0e204dab.js"><link rel="prefetch" href="/blogs/assets/js/11.acf96497.js"><link rel="prefetch" href="/blogs/assets/js/12.0643a22b.js"><link rel="prefetch" href="/blogs/assets/js/13.ca8dd081.js"><link rel="prefetch" href="/blogs/assets/js/14.8bd7b5bd.js"><link rel="prefetch" href="/blogs/assets/js/15.dddb67ac.js"><link rel="prefetch" href="/blogs/assets/js/16.5242688e.js"><link rel="prefetch" href="/blogs/assets/js/17.f03cee5b.js"><link rel="prefetch" href="/blogs/assets/js/18.62a2e5df.js"><link rel="prefetch" href="/blogs/assets/js/19.4ed6e5ac.js"><link rel="prefetch" href="/blogs/assets/js/20.fe87e68d.js"><link rel="prefetch" href="/blogs/assets/js/21.1ca37d7d.js"><link rel="prefetch" href="/blogs/assets/js/22.45f9a0ab.js"><link rel="prefetch" href="/blogs/assets/js/23.5b67a25f.js"><link rel="prefetch" href="/blogs/assets/js/24.864743b6.js"><link rel="prefetch" href="/blogs/assets/js/25.fbb19ce7.js"><link rel="prefetch" href="/blogs/assets/js/26.ae5b791b.js"><link rel="prefetch" href="/blogs/assets/js/27.e490a9f9.js"><link rel="prefetch" href="/blogs/assets/js/28.be291e07.js"><link rel="prefetch" href="/blogs/assets/js/29.a8e70b32.js"><link rel="prefetch" href="/blogs/assets/js/3.42c52160.js"><link rel="prefetch" href="/blogs/assets/js/30.54098e09.js"><link rel="prefetch" href="/blogs/assets/js/31.44b2519f.js"><link rel="prefetch" href="/blogs/assets/js/32.5700c00a.js"><link rel="prefetch" href="/blogs/assets/js/33.d2d52e2a.js"><link rel="prefetch" href="/blogs/assets/js/34.925f7e33.js"><link rel="prefetch" href="/blogs/assets/js/35.ea00a34f.js"><link rel="prefetch" href="/blogs/assets/js/36.8892caa6.js"><link rel="prefetch" href="/blogs/assets/js/37.ef15a63c.js"><link rel="prefetch" href="/blogs/assets/js/38.6d00dfc0.js"><link rel="prefetch" href="/blogs/assets/js/5.4e180a65.js"><link rel="prefetch" href="/blogs/assets/js/6.1ef65951.js"><link rel="prefetch" href="/blogs/assets/js/7.01575413.js"><link rel="prefetch" href="/blogs/assets/js/8.732510c7.js"><link rel="prefetch" href="/blogs/assets/js/9.8a6dd667.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.4772688d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><img src="/blogs/blogs/favicon.ico" alt="Derek's blog" class="logo"> <span class="site-name can-hide">Derek's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/bcld/blogs/tree/master" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/essayist/" class="nav-link">
  随谈
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/foundation/" class="nav-link">
  朝花夕拾
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/private/" class="nav-link">
  私境
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/server/" class="nav-link router-link-active">
  后端
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/blogs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blogs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/bcld/blogs/tree/master" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/essayist/" class="nav-link">
  随谈
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/foundation/" class="nav-link">
  朝花夕拾
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/private/" class="nav-link">
  私境
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/server/" class="nav-link router-link-active">
  后端
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/blogs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>后端</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/docs/server/CAP理论及应用架构.html" class="sidebar-link">CAP理论及应用架构</a></li><li><a href="/blogs/docs/server/java的锁.html" class="sidebar-link">JAVA的锁</a></li><li><a href="/blogs/docs/server/jvm内存结构概述.html" class="active sidebar-link">JVM内存结构剖析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm内存结构概述.html#_1-1-堆内存区" class="sidebar-link">1.1 堆内存区</a></li><li class="sidebar-sub-header"><a href="/blogs/docs/server/jvm内存结构概述.html#_1-2-虚拟机栈" class="sidebar-link">1.2 虚拟机栈</a></li></ul></li><li><a href="/blogs/docs/server/jvm对象分配机制.html" class="sidebar-link">对象分配与类加载机制</a></li><li><a href="/blogs/docs/server/kafka初认识.html" class="sidebar-link">Kafka初认识</a></li><li><a href="/blogs/docs/server/mysql答疑.html" class="sidebar-link">Mysql答疑</a></li><li><a href="/blogs/docs/server/raft一致性协议.html" class="sidebar-link">RAFT</a></li><li><a href="/blogs/docs/server/Redis浅谈.html" class="sidebar-link">浅谈Redis</a></li><li><a href="/blogs/docs/server/RocketMq初认识.html" class="sidebar-link">RocketMq初认识</a></li><li><a href="/blogs/docs/server/TCP相关.html" class="sidebar-link">TCP相关</a></li><li><a href="/blogs/docs/server/分布式锁.html" class="sidebar-link">分布式锁技术</a></li><li><a href="/blogs/docs/server/消息中间件.html" class="sidebar-link">消息中间件</a></li><li><a href="/blogs/docs/server/类加载机制.html" class="sidebar-link">类加载机制</a></li><li><a href="/blogs/docs/server/网络IO模型.html" class="sidebar-link">网络IO模型</a></li><li><a href="/blogs/docs/server/零拷贝技术.html" class="sidebar-link">零拷贝技术</a></li><li><a href="/blogs/docs/server/面试常见问题.html" class="sidebar-link">面试常见问题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jvm内存结构剖析"><a href="#jvm内存结构剖析" class="header-anchor">#</a> JVM内存结构剖析</h1> <p><strong>堆内存区</strong></p> <p>用于存储Java对象的区域，也是GC收集器回收的主要区域</p> <p><strong>方法区</strong></p> <p>主要存储静态变量，静态引用，常量，以及C++层元数据的区域</p> <p><strong>虚拟机栈</strong></p> <p>用与存储方法调用栈，以及保存方法调用过程当中生成的局部变量和局部引用</p> <p><strong>本地方法栈</strong></p> <p>保存java native方法调用栈的地方</p> <p><strong>程序计数器</strong></p> <p>存储代码执行的行号</p> <p><img src="/blogs/assets/img/image-20220511171901638.f0d9206b.png" alt="image-20220511171901638"></p> <p><strong>线程共享</strong></p> <p>这部分每次区域为线程之间共享访问，多线程访问时要注意并发安全</p> <p><strong>线程独占</strong></p> <p>这部分区域由线程独占，如果线程数过多，会造成这部分内存消耗过大</p> <p><strong>问答区：</strong></p> <p>问：我创建的局部对象存储在哪个区域？</p> <p>答：对象一律在堆内存区，但是这个对象的引用(指向这个对象的指针)在栈内存区</p> <p>问：Class对象在方法区吗？</p> <p>答：不准确，Class对象仍然在堆内存区域，只是方法区有这个Class对象的引用</p> <p>问：全局String常量在方法区吗？</p> <p>答：不准确，String仍然是对象，对象就在堆内存区，方法区的字符串常量池持有它的一个引用</p> <h2 id="_1-1-堆内存区"><a href="#_1-1-堆内存区" class="header-anchor">#</a> 1.1 堆内存区</h2> <p>堆内存结构和GC收集器相关，通常经典收集器下(串行收集器/并行收集器/CMS收集器)，将内存划分为如下区域：</p> <p><strong>新生代</strong></p> <p>用于存放刚创建的对象</p> <p><strong>eden</strong></p> <p>新创建对象会直接分片在这块区域内</p> <p><strong>s0,s1</strong></p> <p>youngGC基于复制回收算法，s0,s1主要保存每次youngGC之后的存活对象</p> <p><strong>老年代</strong></p> <p>存放长时间存活的对象</p> <p><img src="/blogs/assets/img/image-20220511171919875.8e8b8b5a.png" alt="image-20220511171919875"></p> <p>为什么要设计分代回收呢？</p> <p><strong>GC分代收集理论</strong></p> <ol><li>弱分代假说：绝大多数对象的生命周期都很短，绝大多数的对象都是朝生夕灭的。</li> <li>强分代假说：熬过越多次垃圾收集过程的对象越难以消亡</li> <li>跨代引用假说：跨代引用相对于同代引用来说仅占极少数</li></ol> <p>如果一个区域里全都是新创建的对象，根据弱分代假说，这些对象里的绝大多数很快将消亡，需要被频繁回收。</p> <p>针对这部分对象Jvm将它们划分到年轻代，并采用牺牲可用内存并提升回收效率的<strong>复制清除算法</strong>。</p> <p>而长期存活的对象，回收频率低。Jvm将这些对象晋升到老年代，并采用比较耗时但内存利用率高的<strong>标记整理算法/标记清除算法</strong></p> <p>同时基于跨代引用假说，跨代引用占比极少，所以划分少量内存，采用<strong>记忆集/卡表</strong>的方式保存跨代引用</p> <h3 id="gc标记算法"><a href="#gc标记算法" class="header-anchor">#</a> GC标记算法</h3> <p><strong>可达性分析算法</strong></p> <p>将“GC Roots” 对象作为起点，从这些节点开始向下搜索引用的对象，找到的对象都标记为非垃圾对象，其余未标记的对象都是垃圾对象</p> <p><strong>GC Roots</strong>：线程栈的本地变量、静态变量、本地方法栈的变量等等</p> <p><img src="/blogs/assets/img/image-20220511171938037.9f8e7e92.png" alt="image-20220511171938037"></p> <h3 id="常见gc收集算法"><a href="#常见gc收集算法" class="header-anchor">#</a> 常见GC收集算法</h3> <p><strong>复制清除算法</strong></p> <p><img src="/blogs/assets/img/image-20220511172001030.c7af27f3.png" alt="image-20220511172001030"></p> <p>缺点：牺牲部分可用内存，并发不安全</p> <p><strong>标记整理算法</strong></p> <p><img src="/blogs/assets/img/image-20220511172009269.ad88c6b3.png" alt="image-20220511172009269"></p> <p>缺点：效率低，并发不安全</p> <p><strong>标记清除算法</strong></p> <p><img src="/blogs/assets/img/image-20220511172018613.06e06523.png" alt="image-20220511172018613"></p> <p>缺点：造成内存碎片</p> <h3 id="记忆集与卡表"><a href="#记忆集与卡表" class="header-anchor">#</a> 记忆集与卡表</h3> <p><strong>记忆集</strong></p> <p>当我们进行young gc时，如果老年代有对象引用了我们的新生代对象，那么老年代的对象也应该加入gc roots的范围中，但是如果每次进行young gc我们都需要扫描一次老年代的话，那我们进行垃圾回收的代价实在是太大了。</p> <p>所以JVM设计者做了这样的设计，用记忆集记录从老年代指向新生代的指针的集合。</p> <p><strong>卡表</strong></p> <p>HotSpot JVM，使用了卡标记（Card Marking）技术来解决老年代到新生代的引用问题。具体是，使用卡表（Card Table）和写屏障（Write Barrier）来进行标记并加快对GC Roots的扫描。</p> <p>卡表是使用一个字节数组实现：CARD_TABLE[ ]，每个元素对应着其标识的内存区域一块特定大小的内存块，称为“卡页”。</p> <p>hotSpot使用的卡页是2^9大小，即512byte。卡页的内存指的是老年代区域内存。</p> <p><img src="/blogs/assets/img/image-20220511172034851.e1e0e836.png" alt="image-20220511172034851"></p> <p>每个卡页中间可能存在多个老年代对象，一旦这些对象有对新生代的引用，这个卡页会变成“脏页”，对应的字节数组元素的值变为1。</p> <p>当发生young GC时，将脏页中所有元素加入gc root。</p> <p><strong>卡表的维护</strong></p> <p>如何让卡表“变脏”，就需要在对应的引用赋值时，将相应的卡表设置成1。</p> <p>Hotspot使用<strong>写屏障</strong>维护卡表状态。</p> <p><strong>问答区：</strong></p> <p>问：内存碎片有什么影响？</p> <p>答：分配对象需要连续内存，碎片过多会导致难以分配大对象</p> <p>问：年轻代复制清除时S0/S1空间不够保存存活的对象怎么办？</p> <p>答：jvm有动态年龄晋升机制，会提前将一部分年龄较大对象晋升到老年代，从而避免出现这种问题</p> <p>问：老年代空间不够用怎么办？</p> <p>答：分配对象前会先FullGC，如果还不够会抛出OOM异常</p> <p>问：写屏障是什么？</p> <p>答：后面章节会讲</p> <h2 id="_1-2-虚拟机栈"><a href="#_1-2-虚拟机栈" class="header-anchor">#</a> 1.2 虚拟机栈</h2> <p>栈内存区和数据结构栈相识，每个线程一个栈，栈内元素由栈帧组成。</p> <p><strong>栈帧</strong></p> <p>栈帧随着方法的调用而创建，随着方法的结束而销毁。方法的结束无论是正常结束，还是异常结束，都算方法的结束。</p> <p>栈帧是一种数据结构，由本地变量表、操作数栈、动态链接、方法出口组成。</p> <p><img src="/blogs/assets/img/image-20220511172042421.79b86515.png" alt="image-20220511172042421"></p> <p><strong>本地变量表</strong></p> <p>本地变量表存放了编译期可知方法的各种局部变量，可以有基本数据类型和对象引用。</p> <p><strong>操作数栈</strong></p> <p>操作数栈是方法执行字节码期间的辅助栈结构。例如如下代码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>a=b+c;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编译成class字节码如下:</p> <ol><li>iload_2  #将本地变量表位置2的变量压入操作数栈</li> <li>iload_3  #将本地变量表位置3的变量压入操作数栈</li> <li>iadd    #对操作数栈执行相加指令</li> <li>istore_1 #将栈内结果保存到本地变量表位置1中</li></ol> <p>栈深度在编译期间就可以确定</p> <p><strong>动态连接</strong></p> <p>class文件中对方法的引用都是符号引用(以字符串常量的形式保存方法名)，但是调用的时候需要转化成直接引用(c++中指向函数的指针)，这样调用的时候才能直接调用对应函数。将符号引用转化为直接引用的过程称为动态连接。</p> <p><strong>方法出口</strong></p> <p>指向方法结束地址的指针</p> <h1 id="_2-相关jvm参数介绍"><a href="#_2-相关jvm参数介绍" class="header-anchor">#</a> 2.相关JVM参数介绍</h1> <p><strong>堆内存区</strong></p> <table><thead><tr><th style="text-align:left;">名称</th> <th style="text-align:left;">参数</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">堆内存初始大小</td> <td style="text-align:left;">-Xms2g</td> <td style="text-align:left;">堆内存初始大小建议和最大值设置一致，不然在扩容过程中会触发fullGC</td></tr> <tr><td style="text-align:left;">堆内存最大值</td> <td style="text-align:left;">-Xmx2g</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">新生代比例</td> <td style="text-align:left;">-XX:NewRatio=2</td> <td style="text-align:left;">设置2表示新生代和老年代比例为1:2</td></tr> <tr><td style="text-align:left;">Survivor区比例</td> <td style="text-align:left;">-XX:SurvivorRatio=8</td> <td style="text-align:left;">设置8表示S0或S1与Eden比例为1:8</td></tr> <tr><td style="text-align:left;">新生代大小</td> <td style="text-align:left;">-Xmn1g</td> <td style="text-align:left;">直接设置新生代大小，优先级比-XX:NewRatio高</td></tr> <tr><td style="text-align:left;">对象晋升年龄</td> <td style="text-align:left;">-XX:MaxTenuringThreshold</td> <td style="text-align:left;">设置对象晋升时的年龄大小，最大为15</td></tr></tbody></table> <p><strong>方法区</strong></p> <table><thead><tr><th style="text-align:left;">名称</th> <th style="text-align:left;">参数</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">永久代初始大小</td> <td style="text-align:left;">-XX:PermSize=64M</td> <td style="text-align:left;">设置永久代空间初始大小（1.7以上弃用）</td></tr> <tr><td style="text-align:left;">永久代最大值</td> <td style="text-align:left;">-XX:MaxPermSize=128M</td> <td style="text-align:left;">1.7以上弃用</td></tr> <tr><td style="text-align:left;">元空间初始化大小</td> <td style="text-align:left;">-XX:MetaspaceSize=256m</td> <td style="text-align:left;">推荐设置，否则jdk可能会动态扩容，每次扩容会导致fullGC</td></tr> <tr><td style="text-align:left;">元空间最大值</td> <td style="text-align:left;">-XX:MaxMetaspaceSize=256m</td> <td style="text-align:left;">推荐初始大小和最大值设置一致，避免扩容导致的fullGC</td></tr></tbody></table> <p><strong>栈内存区</strong></p> <table><thead><tr><th style="text-align:left;">名称</th> <th style="text-align:left;">参数</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">栈内存大小</td> <td style="text-align:left;">-Xss128k</td> <td style="text-align:left;">如果设置太大，系统可创建线程数就会变少。如果设置太少，方法太深的时候会栈溢出。</td></tr></tbody></table> <h1 id="_3-参数配置原则"><a href="#_3-参数配置原则" class="header-anchor">#</a> 3.参数配置原则</h1> <p>JVM参数配置主要是为了保证系统可靠性的基础上，尽可能的减少FullGC</p> <h3 id="元空间设置固定值"><a href="#元空间设置固定值" class="header-anchor">#</a> 元空间设置固定值</h3> <p>-XX:MetaspaceSize以及-XX:MaxMetaspaceSize设置相同的固定值，容量保证可以让服务启动。</p> <p>如果不设置，元空间大小会随着使用自动扩容，扩容的同时会导致FullGC</p> <h3 id="堆内存设置固定值"><a href="#堆内存设置固定值" class="header-anchor">#</a> 堆内存设置固定值</h3> <p>-Xms2g以及-Xmx2g设置相同的固定值，保证系统使用中用足够的运行内存。</p> <p>如果不设置，对内存扩容的过程中，会导致FullGC</p> <h3 id="栈内存设置不要太大"><a href="#栈内存设置不要太大" class="header-anchor">#</a> 栈内存设置不要太大</h3> <p>-Xss可以设置128k，如果设置太大，会导致可用线程数变少</p> <h3 id="尽可能让朝生夕死的对象保留在新生代"><a href="#尽可能让朝生夕死的对象保留在新生代" class="header-anchor">#</a> 尽可能让朝生夕死的对象保留在新生代</h3> <p>由于新生代GC耗时远小于FullGC，所以尽可能让对象早早的就在新生代被清理掉。</p> <p>首先根据预定的性能指标进行压测，通过压测工具知道内存增长速度。</p> <p>通过设置-Xmn适当增加新生代大小，保证新增对象能在新生代能正常回收。而不进入老年代。</p> <p>如果有朝生夕死的对象晋升到老年代，由于这些对象使用后都成了垃圾对象，堆满之后会造成老年代的FullGC。</p> <p>新生代大小不要过大，否则会基于<strong>老年代空间担保机制</strong>，导致MinnorGC之前会触发FullGC。</p> <p><img src="/blogs/assets/img/image-20220511172050678.d2bad2dc.png" alt="image-20220511172050678"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/15/2022, 3:58:26 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blogs/docs/server/java的锁.html" class="prev">
        JAVA的锁
      </a></span> <span class="next"><a href="/blogs/docs/server/jvm对象分配机制.html">
        对象分配与类加载机制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/blogs/assets/js/app.7d827f20.js" defer></script><script src="/blogs/assets/js/2.2efa6d08.js" defer></script><script src="/blogs/assets/js/4.bd087c12.js" defer></script>
  </body>
</html>
